stable_hw:
  enabled: true

  locked_acc_ref:
    enabled: true
    # ★ 推荐：如果你有 dense baseline 的 metrics.json，就填这里（强锁定，最符合 v5.4）
    # baseline_stats_path: "outputs/dense_baseline/metrics.json"
    baseline_stats_path: null
    # ★ 必须 >=1：否则在 baseline_stats_path 为空时永远锁不住 acc_ref
    freeze_epoch: 1

  allow_train_ema_fallback: true

  lambda_hw_schedule:
    enabled: true
    # ★ 必须 >=1：用于 warmup_best 产生 acc_ref（当 baseline_stats_path 为空时）
    warmup_epochs: 1
    ramp_epochs: 1
    lambda_hw_min: 0.0
    lambda_hw_max: 0.08

  normalize:
    mode: hinge_log_ratio
    eps: 1.0e-6
    wT: 0.4
    wE: 0.2
    wM: 0.2
    wC: 0.2
    target_ratio_T: 0.9
    target_ratio_E: 0.9
    mem_hinge_only: true
    clip_term_max: 10.0

  accuracy_guard:
    enabled: true
    controller:
      metric: val_acc1
      epsilon_drop: 0.002
      cut_hw_loss_on_violate: true
      freeze_discrete_updates: true
      freeze_schedule_in_recovery: true
      recovery_min_epochs: 1
      k_exit: 2
      margin_exit: 0.0

  discrete_isolation:
    mapping_update_every_epochs: 1
    layout_update_every_epochs: 1
    use_cached_mapping_for_inner_steps: true
    use_cached_layout_for_inner_steps: true
    track_live_in_inner_steps: false
