stable_hw:
  enabled: true

  # v5.4 canonical: locked acc ref is a dict (no drift)
  locked_acc_ref:
    enabled: true
    # optional: points to EXP-A1 dense baseline stats; if missing -> warmup_best
    baseline_stats_path: null
    freeze_epoch: 0
    prefer_dense_baseline: true

  allow_train_ema_fallback: true

  lambda_hw_schedule:
    enabled: true
    warmup_epochs: 0
    ramp_epochs: 1
    lambda_hw_max: 0.2
    clamp_min: 0.0
    clamp_max: 0.2

  normalize:
    mode: hinge_log_ratio
    eps: 1.0e-6
    wT: 0.4
    wE: 0.2
    wM: 0.2
    wC: 0.2
    target_ratio_T: 0.9
    target_ratio_E: 0.9
    mem_hinge_only: true
    clip_term_max: 10.0

  accuracy_guard:
    enabled: true
    metric: acc1
    epsilon_drop: 0.01
    use_ema: true
    ema_beta: 0.9

    # v5.4 canonical controller (Acc-First Hard Gating)
    controller:
      mode: accuracy_first_hard_gating
      metric: val_acc1
      epsilon_drop: 0.01
      recovery_min_epochs: 1
      cut_hw_loss_on_violate: true
      freeze_discrete_updates: true
      freeze_schedule_in_recovery: true
      k_exit: 2
      margin_exit: 0.002

  discrete_isolation:
    mapping_update_every_epochs: 1
    layout_update_every_epochs: 1
    use_cached_mapping_for_inner_steps: true
    use_cached_layout_for_inner_steps: true
    track_live_in_inner_steps: false
