_base_: configs/ast2_ucf101.yaml

train:
  mode: version_c
  out_dir: outputs/SMOKE/version_c
  seed: 2024

training:
  outer_epochs: 1
  inner_steps_ast: 1
  inner_steps_alpha: 1
  inner_steps_layout: 0

locked_acc_ref:
  enabled: true
  source: "manual"
  acc_ref1: 0.0
  acc_ref5: 0.0

no_drift:
  enabled: true
  stats_path: "${out_dir}/baseline_stats.json"

# === v5.4 StableHW (Acc-First Hard Gating + LockedAccRef + NoDrift + NoDoubleScale) ===
stable_hw:
  enabled: true
  no_double_scale:
    enabled: true

  normalize:
    enabled: true
    mode: hinge_log_ratio

  lambda_hw_schedule:
    enabled: true
    warmup_epochs: 0
    ramp_epochs: 1
    lambda_hw_max: 0.1
    lambda_hw_min: 0.0

  accuracy_guard:
    enabled: true
    controller:
      enabled: true
      metric: "val_acc1"
      epsilon_drop: 1.0   # smoke 里放宽，避免无数据时误触发
      guard_mode: "hard"
      freeze_discrete_updates: true
      freeze_schedule_in_recovery: true
      recovery_min_epochs: 1
      cut_hw_loss_on_violate: true
      k_exit: 1

  negative_guard:
    enabled: true
    mode: clamp
    min_value: 0.0

# 显式关掉旧的“直接相加”入口（validate_and_fill_defaults 也会兜底归零）
hw:
  lambda_hw: 0.0

loss:
  lambda_hw: 0.0

# smoke 只导出 layout_input，避免跑全量
export_layout_input: true
export_dir: outputs/P3/A3/layout_input_smoke
